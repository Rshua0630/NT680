//This source code is generated by UI Designer Studio.

#include "UIFramework.h"
#include "UIFrameworkExt.h"
#include "UIGraphics.h"
#include "NVTToolCommand.h"
#include "MovieRecTestWndRes.c"
#include "MovieRecTestWnd.h"
#include "PrjCfg.h"
#include "UIAppMovie.h"
#include "SysCommon.h"
#include "BurnInWnd.h"
#include "AudioTestWnd.h"
#include "DxOutput.h"
#include "UISetup.h"

#define __MODULE__          MovieRecTest
#define __DBGLVL__          1 // 0=OFF, 1=ERROR, 2=TRACE
#define __DBGFLT__          "*" //*=All, [mark]=CustomClass
#include "DebugModule.h"

//---------------------MovieRecTestWndCtrl Debug Definition -----------------------------
#define _MOVIERECTESTWND_ERROR_MSG        1
#define _MOVIERECTESTWND_TRACE_MSG        0

#if (_MOVIERECTESTWND_ERROR_MSG&(PRJ_DBG_LVL>=PRJ_DBG_LVL_ERR))
#define MovieRecTestWndErrMsg(...)            debug_msg ("^R MovieRecTestWnd: "__VA_ARGS__)
#else
#define MovieRecTestWndErrMsg(...)
#endif

#if (_MOVIERECTESTWND_TRACE_MSG&(PRJ_DBG_LVL>=PRJ_DBG_LVL_TRC))
#define MovieRecTestWndTraceMsg(...)          debug_msg ("^B MovieRecTestWnd: "__VA_ARGS__)
#else
#define MovieRecTestWndTraceMsg(...)
#endif

//---------------------MovieRecTestWndCtrl Global Variables -----------------------------
extern INT32 g_iSysNextMode;

static BOOL     g_bFirstTime = TRUE;
static BOOL     g_bMovieRecWndOpen = FALSE;
static BOOL     g_bMovieRecording = FALSE;
static UINT32   g_uiRecTimeMax = 180; // default record 180 sec
static UINT32   g_uiLEDState = 0;
static UINT32   g_uiAudioGain = 0;

//---------------------MovieRecTestWndCtrl Prototype Declaration  -----------------------

//---------------------MovieRecTestWndCtrl Public API  ----------------------------------
void MovieRecTestWnd_Close(void)
{
    if (g_bMovieRecWndOpen)
    {
        Ux_CloseWindow((VControl *)(&MovieRecTestWndCtrl), 0);
    }
}

void MovieRecTestWnd_SetRecTime(UINT32 uiTime)
{
    g_uiRecTimeMax = uiTime;
}

void MovieRecTestWnd_SetAudioGain(UINT32 uiGain)
{
    g_uiAudioGain = uiGain;
}

//---------------------MovieRecTestWndCtrl Private API  ---------------------------------
static void MovieRecTestWnd_SetLEDState(UINT32 uiState)
{
    switch (uiState)
    {
    case 0:
        LED_TurnOnLED(GPIOMAP_LED_GREEN);
        LED_TurnOffLED(GPIOMAP_LED_RED);
        LED_TurnOnLED(GPIOMAP_LED_FCS);
        LED_TurnOnLED(GPIOMAP_LED_IR);
        break;

    case 2:
        LED_TurnOffLED(GPIOMAP_LED_GREEN);
        LED_TurnOnLED(GPIOMAP_LED_RED);
        LED_TurnOnLED(GPIOMAP_LED_FCS);
        LED_TurnOnLED(GPIOMAP_LED_IR);
        break;

    case 4:
        LED_TurnOnLED(GPIOMAP_LED_GREEN);
        LED_TurnOnLED(GPIOMAP_LED_RED);
        LED_TurnOnLED(GPIOMAP_LED_FCS);
        LED_TurnOnLED(GPIOMAP_LED_IR);
        break;

    case 1:
    case 3:
    case 5:
        LED_TurnOffLED(GPIOMAP_LED_GREEN);
        LED_TurnOffLED(GPIOMAP_LED_RED);
        LED_TurnOffLED(GPIOMAP_LED_FCS);
        LED_TurnOffLED(GPIOMAP_LED_IR);
        break;
    }
}

//---------------------MovieRecTestWndCtrl Control List---------------------------
CTRL_LIST_BEGIN(MovieRecTestWnd)
CTRL_LIST_END

//----------------------MovieRecTestWndCtrl Event---------------------------
INT32 MovieRecTestWnd_OnOpen(VControl *, UINT32, UINT32 *);
INT32 MovieRecTestWnd_OnClose(VControl *, UINT32, UINT32 *);
INT32 MovieRecTestWnd_OnKeyShutter2(VControl *, UINT32, UINT32 *);
INT32 MovieRecTestWnd_OnMovieOneSec(VControl *, UINT32, UINT32 *);
INT32 MovieRecTestWnd_OnStorageSlow(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray);
INT32 MovieRecTestWnd_OnMovieFull(VControl *, UINT32, UINT32 *);
INT32 MovieRecTestWnd_OnBattery(VControl *, UINT32, UINT32 *);
EVENT_BEGIN(MovieRecTestWnd)
EVENT_ITEM(NVTEVT_OPEN_WINDOW,MovieRecTestWnd_OnOpen)
EVENT_ITEM(NVTEVT_CLOSE_WINDOW,MovieRecTestWnd_OnClose)
EVENT_ITEM(NVTEVT_KEY_SHUTTER2,MovieRecTestWnd_OnKeyShutter2)
EVENT_ITEM(NVTEVT_CB_MOVIE_REC_ONE_SEC,MovieRecTestWnd_OnMovieOneSec)
EVENT_ITEM(NVTEVT_CB_MOVIE_SLOW,MovieRecTestWnd_OnStorageSlow)
EVENT_ITEM(NVTEVT_CB_MOVIE_OVERTIME,MovieRecTestWnd_OnMovieFull)
EVENT_ITEM(NVTEVT_CB_MOVIE_FULL,MovieRecTestWnd_OnMovieFull)
EVENT_ITEM(NVTEVT_CB_MOVIE_LOOPREC_FULL,MovieRecTestWnd_OnMovieFull)
EVENT_ITEM(NVTEVT_BATTERY,MovieRecTestWnd_OnBattery)
EVENT_END

INT32 MovieRecTestWnd_OnOpen(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    g_bMovieRecording = FALSE;
    g_bMovieRecWndOpen = TRUE;

    if (g_bFirstTime == TRUE)
    {
        g_bFirstTime = FALSE;
    }
    else
    {
        g_iSysNextMode = PRIMARY_MODE_MOVIE;
        Ux_SetActiveApp(&CustomMovieObjCtrl);
        Ux_SendEvent(0, NVTEVT_EXE_OPEN, 0);
    }

    Ux_FlushEventByRange(NVTEVT_KEY_EVT_START,NVTEVT_KEY_EVT_END);
    Ux_DefaultEvent(pCtrl,NVTEVT_OPEN_WINDOW,paramNum,paramArray);

    Ux_Redraw();
    BurnIn_DrawLoopCount(TRUE);
    AudioTest_DrawData(TRUE);

    g_uiLEDState = 0;
    MovieRecTestWnd_SetLEDState(0);

    // disable ADAS
    Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIE_LDWS, 1, DISABLE);
    Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIE_FCW,  1, DISABLE);
    Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIEGDC,   1, DISABLE);

    // set movie size to 1080p30
    Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIESIZE,  1, MOVIE_SIZE_FRONT_1920x1080P30);

    // disable motion detect
    Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOTION_DET, 1, FALSE);

    // enable audio recording
    Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIE_AUDIO, 1, MOVIE_AUDIO_ON);

    // disable g-sensor
    Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_GSENSOR, 1, GSENSOR_OFF);

    // disable movie protect
    Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIE_PROTECT_AUTO,   1, MOVIE_URGENT_PROTECT_AUTO_OFF);
    Ux_SendEvent(&CustomMovieObjCtrl, NVTEVT_EXE_MOVIE_PROTECT_MANUAL, 1, MOVIE_URGENT_PROTECT_MANUAL_OFF);

    // disable parking mode
    //Ux_SendEvent(&UISetupObjCtrl,     NVTEVT_EXE_PARKING, 1, FALSE);

    Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 1, NVTEVT_KEY_PRESS); // post shutter2 event to start recording

    return NVTEVT_CONSUME;
}

INT32 MovieRecTestWnd_OnClose(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    if (g_bMovieRecording)
    {
        Ux_SendEvent(&CustomMovieObjCtrl,NVTEVT_EXE_MOVIE_REC_STOP,0);
    }

    g_uiLEDState = 0;
    MovieRecTestWnd_SetLEDState(g_uiLEDState);

    Ux_DefaultEvent(pCtrl,NVTEVT_CLOSE_WINDOW,paramNum,paramArray);
    Ux_SendEvent(0, NVTEVT_EXE_CLOSE, 0);
    g_bMovieRecWndOpen = FALSE;
    return NVTEVT_CONSUME;
}

INT32 MovieRecTestWnd_OnKeyShutter2(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
	debug_msg("^C(11) MovieRecTestWnd_OnKeyShutter2\r\n");
    UINT32  uiKeyAct;

    uiKeyAct = paramNum ? paramArray[0] : 0;

    if (uiKeyAct != NVTEVT_KEY_PRESS)
        return NVTEVT_CONSUME;

    if (g_bMovieRecording == FALSE)
    {
        BurnIn_DrawStatus("Recording", CLRID_IDX_WHITE, TRUE);
        BurnIn_DrawTime(0);
        g_bMovieRecording = TRUE;

#if _TODO
        MovRec_ChangeParameter(MOVREC_RECPARAM_CUTSEC, 300, 0, 0); // 5 min
        MovRec_ChangeParameter(MOVREC_RECPARAM_ENDTYPE, MOVREC_ENDTYPE_CUTOVERLAP, 0, 0);

        MovRec_SetAudioVolume(g_uiAudioGain); // set audio gain
#endif
        Ux_FlushEventByRange(NVTEVT_KEY_EVT_START,NVTEVT_KEY_EVT_END);
        Ux_SendEvent(&CustomMovieObjCtrl,NVTEVT_EXE_MOVIE_REC_START,0);
    }
    else
    {
        BurnIn_DrawStatus("Live View", CLRID_IDX_WHITE, TRUE);
        g_bMovieRecording = FALSE;
        Ux_SendEvent(&CustomMovieObjCtrl,NVTEVT_EXE_MOVIE_REC_STOP,0);
        MovieRecTestWnd_Close();
    }
    return NVTEVT_CONSUME;
}

INT32 MovieRecTestWnd_OnMovieOneSec(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    UINT32  uiRecTime;

    uiRecTime = paramArray[0];
    BurnIn_DrawTime(uiRecTime);
    AudioTest_DrawData(TRUE);

    g_uiLEDState++;
    MovieRecTestWnd_SetLEDState(g_uiLEDState % 6);

    if (uiRecTime == g_uiRecTimeMax)
    {
        Ux_PostEvent(NVTEVT_KEY_SHUTTER2, 1, NVTEVT_KEY_PRESS); // post shutter2 event to stop recording
    }
    return NVTEVT_CONSUME;
}

INT32 MovieRecTestWnd_OnStorageSlow(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    BurnIn_DrawStatus("Slow Card!", CLRID_IDX_RED, TRUE);
    Movie_SetSDSlow(TRUE); // set slow card
    g_bMovieRecording = FALSE;
    MovieRecTestWnd_Close();
    return NVTEVT_CONSUME;
}

INT32 MovieRecTestWnd_OnMovieFull(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    BurnIn_DrawStatus("Rec Full!", CLRID_IDX_RED, TRUE);
    g_bMovieRecording = FALSE;
    Ux_SendEvent(&CustomMovieObjCtrl,NVTEVT_EXE_MOVIE_REC_STOP,0);
    MovieRecTestWnd_Close();
    return NVTEVT_CONSUME;
}

INT32 MovieRecTestWnd_OnBattery(VControl *pCtrl, UINT32 paramNum, UINT32 *paramArray)
{
    return NVTEVT_CONSUME;
}


